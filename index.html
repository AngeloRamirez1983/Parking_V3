<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Parking – Estacionamiento Rengo</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0ea5e9" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />

<style>
:root{ --bg:#0b1220; --card:#10192b; --muted:#93a4c0; --txt:#eef2ff; --accent:#0ea5e9; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1220,#0e1a2f);color:var(--txt)}
.container{max-width:1100px;margin:0 auto;padding:16px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between}
h1{margin:8px 0 0;font-size:20px}
.card{background:var(--card);border:1px solid #0b1f38;border-radius:16px;padding:16px;box-shadow:0 10px 30px #0007;margin:12px 0}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
.row>*{flex:1 1 240px}
input,button,select{padding:12px 14px;border-radius:12px;border:1px solid #234;background:#0b1728;color:#eef2ff}
input.upper{text-transform:uppercase}
button{cursor:pointer;font-weight:600}
.btn{background:#0f2a44}
.btn-ok{background:#16803d;border-color:#146c33}
.btn-warn{background:#b96a09;border-color:#9a5808}
.btn-ghost{background:#0d1526;border-color:#15213a}
.hidden{display:none !important}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.tag{display:inline-block;padding:2px 8px;border-radius:9999px;background:#0d1c32;border:1px solid #123;font-size:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #1f2e46;padding:8px;text-align:left}
hr{border:0;border-top:1px solid #1f2e46}
</style>

<!-- libs -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  if ('serviceWorker' in navigator) {
    addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js').catch(console.error));
  }
</script>
</head>
<body>
<div class="container">
  <header>
    <h1>Parking – Estacionamiento Rengo</h1>
    <div class="row" style="max-width:600px">
      <button class="btn" id="goEntrada">Entrada (Alt+E)</button>
      <button class="btn-warn" id="goSalida">Salida (Alt+S)</button>
      <button class="btn" id="goReportes">Reportes</button>
    </div>
  </header>

  <!-- ENTRADA -->
  <section class="card" id="viewEntrada">
    <h2>Entrada</h2>
    <div class="row">
      <div>
        <label>Patente</label>
        <input id="patenteIn" class="upper" placeholder="AA-BB-11" maxlength="10" />
      </div>
      <div>
        <label>Saludo</label>
        <input id="saludoIn" value="Bienvenido!" />
      </div>
      <div>
        <button id="btnGenerar" class="btn-ok">Generar ticket + PDF</button>
      </div>
    </div>

    <div class="card">
      <h3>Preview QR (ID firmado)</h3>
      <div id="qrPreview"></div>
      <div id="idPreview" class="mono" style="margin-top:8px;color:var(--muted)"></div>
    </div>
  </section>

  <!-- SALIDA -->
  <section class="card hidden" id="viewSalida">
    <h2>Salida / Cobro</h2>
    <p class="muted">El lector QR USB actúa como teclado: al escanear, el valor cae aquí y con Enter se procesa automáticamente.</p>
    <div class="row">
      <div style="flex:1 1 100%">
        <label>ID firmado (escanee o pegue y presione Enter)</label>
        <input id="scanInput" placeholder="id.firma" />
      </div>
    </div>
    <div id="chargeArea" class="card hidden">
      <h3>Detalle</h3>
      <table class="table">
        <tbody>
          <tr><th>Patente</th><td id="chPlate" class="mono"></td></tr>
          <tr><th>Ingreso</th><td id="chIn" class="mono"></td></tr>
          <tr><th>Salida</th><td id="chOut" class="mono"></td></tr>
          <tr><th>Duración (min)</th><td id="chDur" class="mono"></td></tr>
          <tr><th>Total ($)</th><td id="chTotal" class="mono"></td></tr>
        </tbody>
      </table>
      <div class="row">
        <button class="btn-ok" id="btnCobrarEfe">Cobrar Efectivo</button>
        <button class="btn" id="btnCobrarTx">Cobrar Transbank</button>
      </div>
    </div>
    <div id="salidaMsg" class="tag" style="margin-top:8px">Listo</div>
  </section>

  <!-- REPORTES -->
  <section class="card hidden" id="viewReportes">
    <h2>Reportes</h2>
    <div class="row">
      <button class="btn" id="btnExportCSV">Exportar CSV</button>
      <button class="btn" id="btnFinDiaPDF">Fin de día (PDF)</button>
    </div>
    <table class="table" id="tblTickets">
      <thead>
        <tr><th>ID</th><th>Patente</th><th>Ingreso</th><th>Salida</th><th>Estado</th><th>Total</th><th>Pago</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<script>
/* ========= Util ========= */
const TZ='America/Santiago';
const $ = (id)=>document.getElementById(id);
const fmtDate = (iso)=> new Date(iso).toLocaleString('es-CL',{timeZone:TZ,hour12:false});
const nowISO = ()=> new Date().toISOString();
const money = (n)=> (Number(n||0)).toLocaleString('es-CL');

function genId(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
const SECRET='CAMBIA-ESTO-EN-PRODUCCION';
function signId(id){
  const sig = CryptoJS.HmacSHA256(id, SECRET).toString(CryptoJS.enc.Hex).slice(0,16);
  return `${id}.${sig}`;
}
function verifySigned(signed){
  const [id, sig] = (signed||'').split('.');
  if(!id||!sig) return null;
  const exp = CryptoJS.HmacSHA256(id, SECRET).toString(CryptoJS.enc.Hex).slice(0,16);
  return sig===exp ? id : null;
}

/* ========= Storage ========= */
const store={
  get(k,def){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): def; }catch(_){ return def; } },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
};
// estructuras
if(!store.get('tickets')) store.set('tickets',{});      // id -> ticket
if(!store.get('payments')) store.set('payments',[]);    // pagos

/* ========= Navegación y atajos ========= */
const VIEWS=['viewEntrada','viewSalida','viewReportes'];
function show(id){ VIEWS.forEach(v=>$(v).classList.add('hidden')); $(id).classList.remove('hidden'); }
$('goEntrada').onclick=()=>{ show('viewEntrada'); $('patenteIn').focus(); };
$('goSalida').onclick =()=>{ show('viewSalida'); $('scanInput').focus(); };
$('goReportes').onclick=()=>{ fillTable(); show('viewReportes'); };

window.addEventListener('keydown',(e)=>{
  if(e.altKey && (e.key==='e'||e.key==='E')){ e.preventDefault(); show('viewEntrada'); $('patenteIn').focus(); }
  if(e.altKey && (e.key==='s'||e.key==='S')){ e.preventDefault(); show('viewSalida'); $('scanInput').focus(); }
});

/* ========= Tarifa simple (puedes ajustar luego) ========= */
const tariff = { firstMinutes:20, firstPrice:500, perMin:20 };
function calcCharge(inISO, outISO){
  const mins = Math.max(0, Math.ceil((new Date(outISO)-new Date(inISO))/60000));
  if(mins<=tariff.firstMinutes) return {mins, total:tariff.firstPrice};
  const extra = mins - tariff.firstMinutes;
  return {mins, total: tariff.firstPrice + extra*tariff.perMin};
}

/* ========= Generación de ticket (Entrada) ========= */
$('patenteIn').addEventListener('input', (e)=>{
  const pos=e.target.selectionStart; e.target.value=e.target.value.toUpperCase(); e.target.setSelectionRange(pos,pos);
});

function renderQRPreview(text){
  const el=$('qrPreview'); el.innerHTML='';
  new QRCode(el, { text, width: 180, height: 180, correctLevel: QRCode.CorrectLevel.M });
}

function buildQRDataURL(text){
  const tmp=document.createElement('div');
  new QRCode(tmp, { text, width: 180, height: 180, correctLevel: QRCode.CorrectLevel.M });
  const img = tmp.querySelector('img') || tmp.querySelector('canvas');
  if(img && img.tagName==='IMG') return img.src;
  if(img && img.tagName==='CANVAS') return img.toDataURL('image/png');
  return '';
}

function saveTicket(t){
  const map=store.get('tickets',{}); map[t.id]=t; store.set('tickets',map);
}
function getTicket(id){ const map=store.get('tickets',{}); return map[id]||null; }
function setTicket(id, t){ const map=store.get('tickets',{}); map[id]=t; store.set('tickets',map); }
function savePayment(ticketId,total,method){
  const pays=store.get('payments',[]); pays.push({ticketId,total,method,at:nowISO()}); store.set('payments',pays);
}

function printTicketPDF({plate,inISO,signed,qrDataURL,welcome}){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'mm', format:[58,200], orientation:'portrait' });

  let y=8, cx=29; // centro (58/2)
  doc.setFont('helvetica','bold'); doc.setFontSize(12);
  doc.text('Bienvenido a Estacionamiento Rengo', cx, y, {align:'center'}); y+=6;
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text(welcome||'Bienvenido!', cx, y, {align:'center'}); y+=8;

  doc.setFont('helvetica','bold'); doc.setFontSize(16);
  doc.text(plate, cx, y, {align:'center'}); y+=8;

  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text('Ingreso:', 4, y);
  const inStr = new Date(inISO).toLocaleString('es-CL',{timeZone:TZ,hour12:false});
  doc.text(inStr, 54, y, {align:'right'}); y+=5;

  doc.setDrawColor(120); doc.line(4,y,54,y); y+=4;

  doc.setFontSize(9);
  doc.text('Recuerde presentar su ticket para el cobro', cx, y, {align:'center'}); y+=5;

  doc.setFontSize(8);
  doc.text('ID:', 4, y); doc.text(signed, 54, y, {align:'right'}); y+=6;

  if(qrDataURL){
    doc.addImage(qrDataURL, 'PNG', (58-40)/2, y, 40, 40); // 40mm ancho
    y+=42;
  }

  doc.setFontSize(8);
  doc.text('¡Conserve este ticket!', cx, y, {align:'center'}); y+=4;

  // abrir en nueva ventana e imprimir
  const blob = doc.output('blob');
  const url = URL.createObjectURL(blob);
  const w = window.open(url);
  if(w){
    w.onload = () => { try{ w.focus(); w.print(); }catch(_){} };
  }else{
    // fallback
    doc.save(`ticket_${plate}.pdf`);
  }
}

$('btnGenerar').onclick = () => {
  const plate = $('patenteIn').value.trim().toUpperCase();
  const welcome = $('saludoIn').value.trim() || 'Bienvenido!';
  if(!plate){ alert('Ingresa la patente'); $('patenteIn').focus(); return; }

  const id = genId();
  const signed = signId(id);
  const inISO = nowISO();

  // Persistir ticket abierto
  const t = { id, signed, plate, in: inISO, out: null, status:'open' };
  saveTicket(t);

  // Render preview QR
  renderQRPreview(signed); $('idPreview').textContent = signed;

  // Generar imagen QR y PDF para impresión en 58x200
  const qrDataURL = buildQRDataURL(signed);
  printTicketPDF({ plate, inISO, signed, qrDataURL, welcome });

  // limpiar campo patente para el siguiente
  $('patenteIn').value=''; $('patenteIn').focus();
};

/* ========= Salida / Cobro ========= */
function handleSigned(raw){
  const id = verifySigned(raw);
  if(!id){ $('salidaMsg').textContent='QR/ID inválido'; $('salidaMsg').style.background='#3a1111'; return; }
  const t = getTicket(id);
  if(!t){ $('salidaMsg').textContent='Ticket no encontrado'; $('salidaMsg').style.background='#3a1111'; return; }
  if(t.status==='closed'){ $('salidaMsg').textContent='Ticket ya cerrado'; $('salidaMsg').style.background='#3a1111'; return; }

  const outISO = nowISO();
  const { mins, total } = calcCharge(t.in, outISO);

  // pintar detalle
  $('chPlate').textContent = t.plate;
  $('chIn').textContent = fmtDate(t.in);
  $('chOut').textContent = fmtDate(outISO);
  $('chDur').textContent = String(mins);
  $('chTotal').textContent = money(total);
  $('chargeArea').classList.remove('hidden');
  $('chargeArea').dataset.id = id;
  $('chargeArea').dataset.total = total;

  $('salidaMsg').textContent='Listo para cobrar';
  $('salidaMsg').style.background='#0d1c32';
}

$('scanInput').addEventListener('keydown',(e)=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const raw = $('scanInput').value.trim();
    if(!raw) return;
    handleSigned(raw);
    $('scanInput').select();
  }
});

function doCharge(method){
  const id = $('chargeArea').dataset.id;
  const total = Number($('chargeArea').dataset.total||0);
  const t = getTicket(id);
  if(!t){ alert('Ticket no encontrado'); return; }
  t.out = nowISO(); t.status='closed'; t.payMethod = method;
  setTicket(id,t); savePayment(id,total,method);
  $('chargeArea').classList.add('hidden');
  $('salidaMsg').textContent = `Cobrado ${money(total)} (${method})`;
  $('salidaMsg').style.background = '#0d1c32';
  fillTable();
}
$('btnCobrarEfe').onclick=()=> doCharge('efectivo');
$('btnCobrarTx').onclick =()=> doCharge('transbank');

/* ========= Reportes ========= */
function fillTable(){
  const tbody = $('tblTickets').querySelector('tbody'); tbody.innerHTML='';
  const map = store.get('tickets',{});
  const pays=store.get('payments',[]);
  const pm = new Map(pays.map(p=>[p.ticketId,p]));
  const rows = Object.values(map).sort((a,b)=> (a.in<b.in?1:-1));
  for(const t of rows){
    const pay = pm.get(t.id);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${t.id}</td>
      <td class="mono">${t.plate}</td>
      <td class="mono">${fmtDate(t.in)}</td>
      <td class="mono">${t.out?fmtDate(t.out):'-'}</td>
      <td>${t.status}</td>
      <td class="mono">${t.out? money(pay?.total||0): '-'}</td>
      <td>${t.out? (pay?.method||'-') : '-'}</td>`;
    tbody.appendChild(tr);
  }
}
$('btnExportCSV').onclick = ()=>{
  const rows=[['ID','Patente','Ingreso','Salida','Estado','Total','Pago']];
  const map=store.get('tickets',{}); const pays=store.get('payments',[]); const pm=new Map(pays.map(p=>[p.ticketId,p]));
  for(const t of Object.values(map)){
    const p=pm.get(t.id); rows.push([t.id,t.plate,fmtDate(t.in),t.out?fmtDate(t.out):'',t.status,t.out?(p?.total||0):'',t.out?(p?.method||''):'']);
  }
  const csv = rows.map(r=> r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download=`tickets_${new Date().toLocaleDateString('en-CA',{timeZone:TZ})}.csv`; a.click();
};
$('btnFinDiaPDF').onclick = ()=>{
  const day = new Date().toLocaleDateString('en-CA',{timeZone:TZ}); // YYYY-MM-DD local
  const { jsPDF } = window.jspdf; const doc = new jsPDF({orientation:'landscape'});
  doc.setFontSize(14); doc.text(`Fin de día – ${day}`, 14, 18);
  doc.setFontSize(10); doc.text(`Generado: ${new Date().toLocaleString('es-CL',{timeZone:TZ,hour12:false})}`,14,25);
  let y=34; doc.setFontSize(9);
  const map=store.get('tickets',{}); const pays=store.get('payments',[]); const pm=new Map(pays.map(p=>[p.ticketId,p]));
  const rows = Object.values(map).filter(t=> new Date(t.in).toLocaleDateString('en-CA',{timeZone:TZ})===day && t.status==='closed');
  doc.text('Patente',14,y); doc.text('Ingreso',40,y); doc.text('Salida',90,y); doc.text('Monto',140,y); doc.text('Medio',165,y);
  y+=4; doc.line(14,y,200,y); y+=6;
  let total=0;
  rows.forEach(r=>{
    const pay=pm.get(r.id); const val=pay?.total||0; total+=val;
    doc.text(r.plate,14,y); doc.text(fmtDate(r.in),40,y); doc.text(fmtDate(r.out),90,y);
    doc.text(money(val),140,y,{align:'right'}); doc.text(pay?.method||'',165,y);
    y+=6; if(y>180){ doc.addPage('landscape'); y=20; }
  });
  y+=6; doc.line(14,y,200,y); y+=8; doc.setFontSize(12);
  doc.text(`Total ventas: $ ${money(total)}`,14,y);
  doc.text(`Autos: ${rows.length}`,100,y);
  doc.save(`fin_dia_${day}.pdf`);
};

/* ========= inicio ========= */
show('viewEntrada');
</script>
</body>
</html>
