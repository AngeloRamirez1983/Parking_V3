<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Parking – Estacionamiento Rengo</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0ea5e9" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />

<style>
:root{ --bg:#0b1220; --card:#10192b; --muted:#93a4c0; --txt:#eef2ff; --accent:#0ea5e9; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1220,#0e1a2f);color:var(--txt)}
.container{max-width:1100px;margin:0 auto;padding:16px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between}
h1{margin:8px 0 0;font-size:20px}
.card{background:var(--card);border:1px solid #0b1f38;border-radius:16px;padding:16px;box-shadow:0 10px 30px #0007;margin:12px 0}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
.row>*{flex:1 1 240px}
input,button,select{padding:12px 14px;border-radius:12px;border:1px solid #234;background:#0b1728;color:#eef2ff}
input.upper{text-transform:uppercase}
button{cursor:pointer;font-weight:600}
.btn{background:#0f2a44}
.btn-ok{background:#16803d;border-color:#146c33}
.btn-warn{background:#b96a09;border-color:#9a5808}
.btn-ghost{background:#0d1526;border-color:#15213a}
.btn-cancel{background:#7a1010;border-color:#5b0c0c}
.hidden{display:none !important}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.tag{display:inline-block;padding:6px 10px;border-radius:9999px;background:#0d1c32;border:1px solid #123;font-size:13px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #1f2e46;padding:8px;text-align:left}
hr{border:0;border-top:1px solid #1f2e46}
.muted{color:var(--muted)}
.biginput{font-size:20px;padding:16px 18px}
.center{display:flex;align-items:center;justify-content:center}
</style>

<!-- libs -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  if ('serviceWorker' in navigator) {
    addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js').catch(console.error));
  }
</script>
</head>
<body>
<div class="container">
  <header>
    <h1>Parking – Estacionamiento Rengo</h1>
    <div class="row" style="max-width:900px">
      <button class="btn" id="goEntrada">Entrada (Alt+E)</button>
      <button class="btn-warn" id="goSalida">Salida (Alt+S)</button>
      <button class="btn" id="goReportes">Reportes</button>
      <button class="btn hidden" id="goAdmin">Admin</button>
      <button class="btn-ghost hidden" id="btnLogout">Cerrar sesión</button>
      <span id="who" class="muted"></span>
    </div>
  </header>

  <!-- LOGIN -->
  <section class="card" id="viewLogin">
    <h2>Acceso</h2>
    <div class="row">
      <div><label>Usuario</label><input id="loginUser" placeholder="admin u operador" /></div>
      <div><label>Clave</label><input id="loginPass" type="password" placeholder="*****" /></div>
      <div style="align-self:flex-end"><button id="doLogin" class="btn-ok">Entrar</button></div>
    </div>
    <div class="muted" style="margin-top:6px">Admin: <span class="mono">admin / 12345</span> · Operador: <span class="mono">operador / 67890</span></div>
  </section>

  <!-- ENTRADA -->
  <section class="card hidden" id="viewEntrada">
    <h2>Entrada</h2>
    <div class="row">
      <div>
        <label>Patente</label>
        <input id="patenteIn" class="upper" placeholder="AA-BB-11" maxlength="10" />
      </div>
      <div>
        <label>Saludo</label>
        <input id="saludoIn" value="Bienvenido!" />
      </div>
      <div>
        <button id="btnGenerar" class="btn-ok">Generar ticket + PDF</button>
      </div>
    </div>

    <div class="card">
      <h3>Preview QR (ID firmado)</h3>
      <div id="qrPreview"></div>
      <div id="idPreview" class="mono" style="margin-top:8px;color:var(--muted)"></div>
    </div>
  </section>

  <!-- SALIDA -->
  <section class="card hidden" id="viewSalida">
    <h2>Salida / Cobro</h2>
    <p class="muted">Lector QR USB: apunta el cursor al campo grande de abajo. La mayoría de lectores envía <b>Enter</b> al final → se cobra automático (efectivo por defecto).</p>
    <div class="row">
      <div style="flex:1 1 100%">
        <label>ID firmado (escanee o pegue y presione Enter)</label>
        <input id="scanInput" class="biginput" placeholder="id.firma" />
      </div>
    </div>
    <div class="center" style="margin-top:8px">
      <div id="salidaMsg" class="tag">Listo para escanear</div>
    </div>

    <div id="chargeArea" class="card hidden" style="margin-top:12px">
      <h3>Detalle</h3>
      <table class="table">
        <tbody>
          <tr><th>Patente</th><td id="chPlate" class="mono"></td></tr>
          <tr><th>Ingreso</th><td id="chIn" class="mono"></td></tr>
          <tr><th>Salida</th><td id="chOut" class="mono"></td></tr>
          <tr><th>Duración (min)</th><td id="chDur" class="mono"></td></tr>
          <tr><th>Total ($)</th><td id="chTotal" class="mono"></td></tr>
          <tr><th>Tope diario</th><td id="chCap" class="mono"></td></tr>
        </tbody>
      </table>
      <div class="row">
        <button class="btn-ok" id="btnCobrarEfe">Cobrar Efectivo</button>
        <button class="btn" id="btnCobrarTx">Cobrar Transbank</button>
      </div>
    </div>
  </section>

  <!-- REPORTES -->
  <section class="card hidden" id="viewReportes">
    <h2>Reportes</h2>
    <div class="row">
      <button class="btn" id="btnExportCSV">Exportar CSV</button>
      <button class="btn" id="btnFinDiaPDF">Fin de día (PDF)</button>
    </div>
    <table class="table" id="tblTickets">
      <thead>
        <tr><th>ID</th><th>Patente</th><th>Ingreso</th><th>Salida</th><th>Estado</th><th>Total</th><th>Pago</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ADMIN -->
  <section class="card hidden" id="viewAdmin">
    <h2>Administración</h2>
    <div class="row">
      <div><label>Primer intervalo (min)</label><input id="tFirstMin" type="number" min="0" /></div>
      <div><label>Precio primer intervalo ($)</label><input id="tFirstPrice" type="number" min="0" /></div>
      <div><label>Precio por minuto adicional ($)</label><input id="tPerMin" type="number" min="0" /></div>
      <div><label>Máximo diario por ticket ($)</label><input id="tDailyCap" type="number" min="0" /></div>
      <div style="align-self:flex-end"><button id="btnSaveTariff" class="btn-ok">Guardar parámetros</button></div>
    </div>
    <p class="muted">El total cobrado por un ticket en un mismo día no superará el <b>máximo diario</b>. Por defecto: $10.000.</p>
  </section>
</div>

<script>
/* ========= Config ========= */
const TZ='America/Santiago';
const AUTO_CHARGE=true;           // cobra al apretar Enter en Salida
const DEFAULT_METHOD='efectivo';  // método por defecto

/* ========= Utils ========= */
const $ = (id)=>document.getElementById(id);
const fmtDate = (iso)=> new Date(iso).toLocaleString('es-CL',{timeZone:TZ,hour12:false});
const nowISO = ()=> new Date().toISOString();
const todayLocal = ()=> new Date().toLocaleDateString('en-CA',{timeZone:TZ}); // YYYY-MM-DD
const money = (n)=> (Number(n||0)).toLocaleString('es-CL');

function genId(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
const SECRET='CAMBIA-ESTO-EN-PRODUCCION';
function signId(id){
  const sig = CryptoJS.HmacSHA256(id, SECRET).toString(CryptoJS.enc.Hex).slice(0,16);
  return `${id}.${sig}`;
}
function verifySigned(signed){
  const [id, sig] = (signed||'').split('.');
  if(!id||!sig) return null;
  const exp = CryptoJS.HmacSHA256(id, SECRET).toString(CryptoJS.enc.Hex).slice(0,16);
  return sig===exp ? id : null;
}

/* ========= Storage ========= */
const store={
  get(k,def){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): def; }catch(_){ return def; } },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
  del(k){ localStorage.removeItem(k); }
};
if(!store.get('tickets')) store.set('tickets',{});      // id -> ticket
if(!store.get('payments')) store.set('payments',[]);    // pagos
if(!store.get('users')) store.set('users',[
  {user:'admin', pass:'12345', role:'admin'},
  {user:'operador', pass:'67890', role:'operador'}
]);
// Tarifa con tope diario
if(!store.get('tariff')) store.set('tariff', { firstMinutes:20, firstPrice:500, perMin:20, dailyCap:10000 });

/* ========= Sesión / Login ========= */
const session = { user:null, role:null };
function saveSession(){ store.set('session', {user:session.user, role:session.role}); }
function loadSession(){ const s=store.get('session',null); if(!s) return false; session.user=s.user; session.role=s.role; return !!session.user; }
function clearSession(){ store.del('session'); session.user=null; session.role=null; }

function login(u,p){
  const user = store.get('users',[]).find(x=>x.user===u && x.pass===p);
  if(!user) return false;
  session.user=user.user; session.role=user.role; saveSession(); return true;
}

function updateHeader(){
  const logged = !!session.user;
  $('btnLogout').classList.toggle('hidden', !logged);
  $('goAdmin').classList.toggle('hidden', !(logged && session.role==='admin'));
  $('who').textContent = logged ? `Sesión: ${session.user} (${session.role})` : '';
}

$('doLogin').onclick = ()=>{
  const u=$('loginUser').value.trim(), p=$('loginPass').value.trim();
  if(!login(u,p)){ alert('Credenciales inválidas'); return; }
  updateHeader(); show('viewEntrada'); $('patenteIn').focus();
};
$('btnLogout').onclick = ()=>{
  clearSession(); show('viewLogin'); updateHeader();
};
['loginUser','loginPass'].forEach(id=>{
  $(id).addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); $('doLogin').click(); } });
});

/* ========= Navegación y atajos ========= */
const VIEWS=['viewLogin','viewEntrada','viewSalida','viewReportes','viewAdmin'];
function show(id){ VIEWS.forEach(v=>$(v).classList.add('hidden')); $(id).classList.remove('hidden'); }
$('goEntrada').onclick=()=>{ if(!session.user){ show('viewLogin'); return;} show('viewEntrada'); $('patenteIn').focus(); };
$('goSalida').onclick =()=>{ if(!session.user){ show('viewLogin'); return;} show('viewSalida'); $('scanInput').focus(); };
$('goReportes').onclick=()=>{ if(!session.user){ show('viewLogin'); return;} fillTable(); show('viewReportes'); };
$('goAdmin').onclick=()=>{ if(!(session.user && session.role==='admin')){ show('viewLogin'); return;} loadTariffUI(); show('viewAdmin'); };

window.addEventListener('keydown',(e)=>{
  if(e.altKey && (e.key==='e'||e.key==='E')){ e.preventDefault(); if(!session.user){ show('viewLogin'); return;} show('viewEntrada'); $('patenteIn').focus(); }
  if(e.altKey && (e.key==='s'||e.key==='S')){ e.preventDefault(); if(!session.user){ show('viewLogin'); return;} show('viewSalida'); $('scanInput').focus(); }
});

/* ========= Tarifa + Cálculo (con tope diario) ========= */
function getTariff(){ return store.get('tariff',{ firstMinutes:20, firstPrice:500, perMin:20, dailyCap:10000 }); }
function setTariff(t){ store.set('tariff', t); }
function calcCharge(inISO, outISO){
  const t = getTariff();
  const mins = Math.max(0, Math.ceil((new Date(outISO)-new Date(inISO))/60000));
  let total;
  if(mins<=t.firstMinutes) total = t.firstPrice;
  else total = t.firstPrice + (mins - t.firstMinutes) * t.perMin;
  // aplica tope diario por ticket
  total = Math.min(total, t.dailyCap||Infinity);
  return {mins, total, cap:t.dailyCap||Infinity};
}

/* ========= Admin UI ========= */
function loadTariffUI(){
  const t=getTariff();
  $('tFirstMin').value = t.firstMinutes;
  $('tFirstPrice').value = t.firstPrice;
  $('tPerMin').value = t.perMin;
  $('tDailyCap').value = t.dailyCap;
}
$('btnSaveTariff').onclick = ()=>{
  if(!(session.user && session.role==='admin')){ alert('Solo admin'); return; }
  const t={
    firstMinutes: Math.max(0, parseInt($('tFirstMin').value||'0',10)),
    firstPrice:   Math.max(0, parseInt($('tFirstPrice').value||'0',10)),
    perMin:       Math.max(0, parseInt($('tPerMin').value||'0',10)),
    dailyCap:     Math.max(0, parseInt($('tDailyCap').value||'0',10))
  };
  setTariff(t);
  alert('Parámetros guardados.');
};

/* ========= Entrada: generar ticket + PDF (45x250 con QR) ========= */
$('patenteIn').addEventListener('input', (e)=>{
  const pos=e.target.selectionStart; e.target.value=e.target.value.toUpperCase(); e.target.setSelectionRange(pos,pos);
});
function renderQRPreview(text){
  const el=$('qrPreview'); el.innerHTML='';
  new QRCode(el, { text, width: 180, height: 180, correctLevel: QRCode.CorrectLevel.M });
}
function buildQRDataURL(text){
  const tmp=document.createElement('div');
  new QRCode(tmp, { text, width: 180, height: 180, correctLevel: QRCode.CorrectLevel.M });
  const img = tmp.querySelector('img') || tmp.querySelector('canvas');
  if(img && img.tagName==='IMG') return img.src;
  if(img && img.tagName==='CANVAS') return img.toDataURL('image/png');
  return '';
}
function saveTicket(t){ const map=store.get('tickets',{}); map[t.id]=t; store.set('tickets',map); }
function getTicket(id){ const map=store.get('tickets',{}); return map[id]||null; }
function setTicket(id, t){ const map=store.get('tickets',{}); map[id]=t; store.set('tickets',map); }
function savePayment(ticketId,total,method){ const pays=store.get('payments',[]); pays.push({ticketId,total,method,at:nowISO(),by:session.user}); store.set('payments',pays); }

function printTicketPDF({plate,inISO,signed,qrDataURL,welcome}){
  const { jsPDF } = window.jspdf;
  // tamaño solicitado: 45mm x 250mm
  const W=45, H=250;
  const doc = new jsPDF({ unit:'mm', format:[W,H], orientation:'portrait' });

  let y=8, cx=W/2;
  doc.setFont('helvetica','bold'); doc.setFontSize(11);
  doc.text('Bienvenido a Estacionamiento Rengo', cx, y, {align:'center'}); y+=6;
  doc.setFont('helvetica','normal'); doc.setFontSize(9);
  doc.text(welcome||'Bienvenido!', cx, y, {align:'center'}); y+=8;

  doc.setFont('helvetica','bold'); doc.setFontSize(15);
  doc.text(plate, cx, y, {align:'center'}); y+=8;

  doc.setFont('helvetica','normal'); doc.setFontSize(9);
  doc.text('Ingreso:', 3, y);
  const inStr = new Date(inISO).toLocaleString('es-CL',{timeZone:TZ,hour12:false});
  doc.text(inStr, W-3, y, {align:'right'}); y+=5;

  doc.setDrawColor(120); doc.line(3,y,W-3,y); y+=4;

  doc.setFontSize(8);
  doc.text('Recuerde presentar su ticket para el cobro', cx, y, {align:'center'}); y+=5;

  // ID en varias líneas si es necesario
  doc.setFontSize(8);
  const idParts = doc.splitTextToSize(`ID: ${signed}`, W-6);
  idParts.forEach(line=>{ doc.text(line, 3, y); y+=4; });

  if(qrDataURL){
    const QRW=30, QRH=30, x=(W-QRW)/2;
    doc.addImage(qrDataURL, 'PNG', x, y, QRW, QRH);
    y+=QRH+6;
  }

  doc.setFontSize(8);
  doc.text('¡Conserve este ticket!', cx, y, {align:'center'}); y+=4;

  // imprime
  const blob = doc.output('blob');
  const url = URL.createObjectURL(blob);
  const w = window.open(url);
  if(w){ w.onload = () => { try{ w.focus(); w.print(); }catch(_){} }; }
  else { doc.save(`ticket_${plate}.pdf`); }
}

$('btnGenerar').onclick = () => {
  if(!session.user){ show('viewLogin'); return; }
  const plate = $('patenteIn').value.trim().toUpperCase();
  const welcome = $('saludoIn').value.trim() || 'Bienvenido!';
  if(!plate){ alert('Ingresa la patente'); $('patenteIn').focus(); return; }

  const id = genId();
  const signed = signId(id);
  const inISO = nowISO();

  const t = { id, signed, plate, in: inISO, out: null, status:'open', by:session.user };
  saveTicket(t);

  renderQRPreview(signed); $('idPreview').textContent = signed;

  const qrDataURL = buildQRDataURL(signed);
  printTicketPDF({ plate, inISO, signed, qrDataURL, welcome });

  $('patenteIn').value=''; $('patenteIn').focus();
};

/* ========= Salida / Cobro (lector) ========= */
function handleSigned(raw, auto=true){
  if(!session.user){ show('viewLogin'); return; }
  const id = verifySigned(raw);
  if(!id){ $('salidaMsg').textContent='QR/ID inválido'; $('salidaMsg').style.background='#3a1111'; return; }
  const t = getTicket(id);
  if(!t){ $('salidaMsg').textContent='Ticket no encontrado'; $('salidaMsg').style.background='#3a1111'; return; }
  if(t.status==='closed'){ $('salidaMsg').textContent='Ticket ya cerrado'; $('salidaMsg').style.background='#3a1111'; return; }

  const outISO = nowISO();
  const { mins, total, cap } = calcCharge(t.in, outISO);

  $('chPlate').textContent = t.plate;
  $('chIn').textContent    = fmtDate(t.in);
  $('chOut').textContent   = fmtDate(outISO);
  $('chDur').textContent   = String(mins);
  $('chTotal').textContent = money(total);
  $('chCap').textContent   = money(cap);

  $('chargeArea').classList.remove('hidden');
  $('chargeArea').dataset.id = id;
  $('chargeArea').dataset.total = total;

  $('salidaMsg').textContent='Listo para cobrar';
  $('salidaMsg').style.background='#0d1c32';

  if(auto && AUTO_CHARGE){
    doCharge(DEFAULT_METHOD);
  }
}
$('scanInput').addEventListener('keydown',(e)=>{
  if(e.key==='Enter'){
    e.preventDefault();
    const raw = $('scanInput').value.trim();
    if(!raw) return;
    handleSigned(raw, true);
    $('scanInput').select();
  }
});
function doCharge(method){
  const id = $('chargeArea').dataset.id;
  const total = Number($('chargeArea').dataset.total||0);
  const t = getTicket(id);
  if(!t){ alert('Ticket no encontrado'); return; }
  t.out = nowISO(); t.status='closed'; t.payMethod = method;
  setTicket(id,t); savePayment(id,total,method);
  $('chargeArea').classList.add('hidden');
  $('salidaMsg').textContent = `Cobrado ${money(total)} (${method})`;
  $('salidaMsg').style.background = '#0d1c32';
  fillTable();
}
$('btnCobrarEfe').onclick=()=> doCharge('efectivo');
$('btnCobrarTx').onclick =()=> doCharge('transbank');

/* ========= Reportes ========= */
function fillTable(){
  const tbody = $('tblTickets').querySelector('tbody'); tbody.innerHTML='';
  const map = store.get('tickets',{});
  const pays=store.get('payments',[]);
  const pm = new Map(pays.map(p=>[p.ticketId,p]));
  const rows = Object.values(map).sort((a,b)=> (a.in<b.in?1:-1));
  for(const t of rows){
    const pay = pm.get(t.id);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${t.id}</td>
      <td class="mono">${t.plate}</td>
      <td class="mono">${fmtDate(t.in)}</td>
      <td class="mono">${t.out?fmtDate(t.out):'-'}</td>
      <td>${t.status}</td>
      <td class="mono">${t.out? money(pay?.total||0): '-'}</td>
      <td>${t.out? (pay?.method||'-') : '-'}</td>`;
    tbody.appendChild(tr);
  }
}
$('btnExportCSV').onclick = ()=>{
  const rows=[['ID','Patente','Ingreso','Salida','Estado','Total','Pago']];
  const map=store.get('tickets',{}); const pays=store.get('payments',[]); const pm=new Map(pays.map(p=>[p.ticketId,p]));
  for(const t of Object.values(map)){
    const p=pm.get(t.id); rows.push([t.id,t.plate,fmtDate(t.in),t.out?fmtDate(t.out):'',t.status,t.out?(p?.total||0):'',t.out?(p?.method||''):'']);
  }
  const csv = rows.map(r=> r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download=`tickets_${todayLocal()}.csv`; a.click();
};
$('btnFinDiaPDF').onclick = ()=>{
  const day = todayLocal();
  const { jsPDF } = window.jspdf; const doc = new jsPDF({orientation:'landscape'});
  doc.setFontSize(14); doc.text(`Fin de día – ${day}`, 14, 18);
  doc.setFontSize(10); doc.text(`Generado: ${new Date().toLocaleString('es-CL',{timeZone:TZ,hour12:false})}`,14,25);
  let y=34; doc.setFontSize(9);
  const map=store.get('tickets',{}); const pays=store.get('payments',[]); const pm=new Map(pays.map(p=>[p.ticketId,p]));
  const rows = Object.values(map).filter(t=> new Date(t.in).toLocaleDateString('en-CA',{timeZone:TZ})===day && t.status==='closed');
  doc.text('Patente',14,y); doc.text('Ingreso',40,y); doc.text('Salida',90,y); doc.text('Monto',140,y); doc.text('Medio',165,y);
  y+=4; doc.line(14,y,200,y); y+=6;
  let total=0;
  rows.forEach(r=>{
    const pay=pm.get(r.id); const val=pay?.total||0; total+=val;
    doc.text(r.plate,14,y); doc.text(fmtDate(r.in),40,y); doc.text(fmtDate(r.out),90,y);
    doc.text(money(val),140,y,{align:'right'}); doc.text(pay?.method||'',165,y);
    y+=6; if(y>180){ doc.addPage('landscape'); y=20; }
  });
  y+=6; doc.line(14,y,200,y); y+=8; doc.setFontSize(12);
  doc.text(`Total ventas: $ ${money(total)}`,14,y);
  doc.text(`Autos: ${rows.length}`,100,y);
  doc.save(`fin_dia_${day}.pdf`);
};

/* ========= inicio ========= */
(function init(){
  if(loadSession()){ updateHeader(); show('viewEntrada'); $('patenteIn').focus(); }
  else{ updateHeader(); show('viewLogin'); }
})();
</script>
</body>
</html>
