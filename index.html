<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Parking ‚Äì Espacio Quintalba - Rengo</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0ea5e9" />
<link rel="apple-touch-icon" href="icons/icon-192.png" />

<style>
:root{
  --bg:#0b1220; --card:#10192b; --muted:#93a4c0; --txt:#eef2ff; --accent:#0ea5e9;
  --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --badge:#0d1c32; --border:#123;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1220,#0e1a2f);color:var(--txt)}
.container{max-width:1200px;margin:0 auto;padding:16px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
h1{margin:8px 0 0;font-size:20px}
.card{background:var(--card);border:1px solid #0b1f38;border-radius:16px;padding:16px;box-shadow:0 10px 30px #0007;margin:12px 0}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
.row>*{flex:1 1 240px}
input,button,select{padding:12px 14px;border-radius:12px;border:1px solid #234;background:#0b1728;color:#eef2ff}
input.upper{text-transform:uppercase}
input.biginput{font-size:20px;padding:16px 18px}
button{cursor:pointer;font-weight:600}
.btn{background:#0f2a44}
.btn-ok{background:#16803d;border-color:#146c33}
.btn-warn{background:#b96a09;border-color:#9a5808}
.btn-ghost{background:#0d1526;border-color:#15213a}
.btn-cancel{background:#7a1010;border-color:#5b0c0c}
.btn.active{outline:2px solid var(--accent); box-shadow:0 0 0 2px #0a2a44 inset}
.hidden{display:none !important}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.tag{display:inline-block;padding:6px 10px;border-radius:9999px;background:var(--badge);border:1px solid var(--border);font-size:13px}
.badge{display:inline-flex;gap:6px;align-items:center;padding:8px 14px;border-radius:14px;background:var(--badge);border:1px solid var(--border);font-size:15px;font-weight:700}
.kpi{display:flex;gap:8px;align-items:center}
.kpi b{font-size:16px}
.kpi-large{font-size:18px;padding:10px 16px;border:2px solid #1e3a5f;border-radius:14px}
.kpi-low{background:#3a1f10;border-color:#7a3a0a}
.kpi-ok{background:#103a1a;border-color:#1c6b2a}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #1f2e46;padding:8px;text-align:left}
hr{border:0;border-top:1px solid #1f2e46}
.muted{color:var(--muted)}
.center{display:flex;align-items:center;justify-content:center}
.right{display:flex;align-items:center;gap:12px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.amount-box{background:#0d1c32;border:1px solid #234;border-radius:16px;padding:16px;text-align:center}
.amount-box h1{margin:0;font-size:40px;letter-spacing:1px}
.modal-backdrop{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;z-index:50}
.modal{background:var(--card);border:1px solid #0b1f38;border-radius:16px;padding:16px;max-width:900px;width:95%}
.modal h3{margin-top:4px}
.modal .table{max-height:50vh;overflow:auto;display:block}
.modal .table table{width:100%}
.backbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}

/* Users admin */
.users-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:8px}
.users-form{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin:10px 0}
.users-form>*{flex:1 1 220px}
.role-pill{padding:4px 10px;border-radius:999px;border:1px solid #1d3659;background:#0c1a2d;font-size:12px}
.actions{display:flex;gap:8px}

/* Totales Reporte */
.summary{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
.summary .box{background:#0d1c32;border:1px solid #234;border-radius:14px;padding:12px 16px}
.summary .box h4{margin:0 0 4px 0;font-size:14px;color:#93a4c0}
.summary .box .big{font-size:22px;font-weight:800}

/* Dise√±o alternativo */
body.alt .card{border-radius:8px; box-shadow:0 8px 18px #0006}
body.alt .btn{border-radius:8px}
body.alt .kpi-large{border-radius:8px}
body.alt input, body.alt select{border-radius:8px}
</style>

<!-- libs -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  if ('serviceWorker' in navigator) {
    addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js').catch(console.error));
  }
</script>
</head>
<body>
<div class="container">
  <header>
    <div class="toolbar">
      <h1>Parking ‚Äì Espacio Quintalba - Rengo</h1>
      <span id="occupancyTag" class="badge kpi-large">Disponibles: ‚Äî / Capacidad: ‚Äî</span>
    </div>
    <div class="toolbar">
      <button class="btn" id="goEntrada">Entrada (Alt+E)</button>
      <button class="btn" id="goSalida">Salida (Alt+S)</button>
      <button class="btn" id="goReportes">Reportes</button>
      <button class="btn" id="btnBuscar">Buscar Veh√≠culo</button>
      <button class="btn hidden" id="goAdmin">Admin</button>
      <button class="btn-ghost hidden" id="btnLogout">Cerrar sesi√≥n</button>
      <span id="who" class="muted"></span>
      <label class="tag" style="cursor:pointer"><input type="checkbox" id="toggleDesign" style="margin-right:6px">Dise√±o alternativo</label>
    </div>
  </header>

  <!-- LOGIN -->
  <section class="card" id="viewLogin">
    <h2>Acceso</h2>
    <div class="row">
      <div><label>Usuario</label><input id="loginUser" placeholder="usuario" autocomplete="username" /></div>
      <div><label>Clave</label><input id="loginPass" type="password" placeholder="*****" autocomplete="current-password" /></div>
      <div style="align-self:flex-end"><button id="doLogin" class="btn-ok">Entrar</button></div>
    </div>
  </section>

  <!-- ENTRADA -->
  <section class="card hidden" id="viewEntrada">
    <div class="backbar"><button class="btn-ghost" id="backEntrada">‚Üê Atr√°s</button><h2>Entrada</h2><div class="kpi"><span class="muted">Disponibles:</span> <b id="freeOnEntrada">‚Äî</b></div></div>
    <div id="zBannerEntrada" class="tag hidden" style="background:#3a1111;border-color:#5b1a1a;margin-bottom:8px">üö´ Cierre Z activo para hoy. No se pueden hacer nuevas entradas.</div>
    <div class="row">
      <div>
        <label>Patente</label>
        <input id="patenteIn" class="upper" placeholder="AA-BB-11" maxlength="10" />
      </div>
      <div>
        <label>Saludo</label>
        <input id="saludoIn" value="¬°Bienvenido!" />
      </div>
      <div>
        <button id="btnGenerar" class="btn-ok">Generar ticket + PDF</button>
      </div>
    </div>

    <div class="card">
      <h3>Preview QR (ID firmado)</h3>
      <div id="qrPreview"></div>
      <div id="idPreview" class="mono" style="margin-top:8px;color:var(--muted)"></div>
    </div>
  </section>

  <!-- SALIDA -->
  <section class="card hidden" id="viewSalida">
    <div class="backbar"><button class="btn-ghost" id="backSalida">‚Üê Atr√°s</button><h2>Salida / Cobro</h2><div class="kpi"><span class="muted">Disponibles:</span> <b id="freeOnSalida">‚Äî</b></div></div>
    <div id="zBannerSalida" class="tag hidden" style="background:#3a1111;border-color:#5b1a1a;margin-bottom:8px">üö´ Cierre Z activo para hoy. No se pueden realizar cobros.</div>
    <p class="muted">Lector QR USB: enfoque el campo grande, escanee; la mayor√≠a agrega <b>Enter</b> al final.</p>
    <div class="row">
      <div style="flex:1 1 100%">
        <label>ID firmado (escanee o pegue y presione Enter)</label>
        <input id="scanInput" class="biginput" placeholder="id.firma" />
      </div>
    </div>

    <div id="chargeArea" class="card hidden" style="margin-top:12px">
      <h3>Detalle</h3>
      <div class="amount-box">
        <div class="muted">Total a cobrar</div>
        <h1 id="bigAmount">$0</h1>
      </div>
      <table class="table" style="margin-top:10px">
        <tbody>
          <tr><th>Patente</th><td id="chPlate" class="mono"></td></tr>
          <tr><th>Ingreso</th><td id="chIn" class="mono"></td></tr>
          <tr><th>Salida</th><td id="chOut" class="mono"></td></tr>
          <tr><th>Duraci√≥n (min)</th><td id="chDur" class="mono"></td></tr>
          <tr><th>Tope diario</th><td id="chCap" class="mono"></td></tr>
        </tbody>
      </table>
      <div class="row">
        <button class="btn-ok" id="btnCobrarEfe">Cobrar Efectivo</button>
        <button class="btn" id="btnCobrarTx">Cobrar Transbank</button>
      </div>
    </div>
    <div class="center" style="margin-top:8px"><div id="salidaMsg" class="tag">Listo para escanear</div></div>
  </section>

  <!-- REPORTES -->
  <section class="card hidden" id="viewReportes">
    <div class="backbar"><button class="btn-ghost" id="backReportes">‚Üê Atr√°s</button><h2>Reportes</h2></div>
    <div class="row">
      <div>
        <label>Estado</label>
        <select id="filterStatus">
          <option value="todos">Todos</option>
          <option value="abiertos">En estacionamiento</option>
          <option value="cerrados">Fuera del estacionamiento</option>
        </select>
      </div>
      <div>
        <label>Buscar por patente</label>
        <input id="filterPlate" placeholder="AA-BB-11" class="upper" />
      </div>
      <div>
        <label>Desde</label>
        <input type="date" id="filterFrom" />
      </div>
      <div>
        <label>Hasta</label>
        <input type="date" id="filterTo" />
      </div>
      <div style="align-self:flex-end">
        <button class="btn" id="btnApplyFilter">Aplicar filtro</button>
      </div>
    </div>

    <!-- Totales visibles del rango filtrado -->
    <div class="summary" id="summaryBoxes">
      <div class="box"><h4>Total ventas (rango)</h4><div class="big" id="sumTotal">$0</div></div>
      <div class="box"><h4>Veh√≠culos fuera</h4><div class="big" id="sumCount">0</div></div>
    </div>

    <div class="row" style="margin-top:6px">
      <button class="btn" id="btnCierreX">Cierre X (XLSX+PDF)</button>
      <button class="btn-warn" id="btnCierreZ">Cierre Z (XLSX+PDF)</button>
    </div>
    <table class="table" id="tblTickets">
      <thead>
        <tr>
          <th>ID</th><th>Patente</th><th>Ingreso</th><th>Salida</th><th>Estado</th><th>Total</th><th>Pago</th><th>Operador</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ADMIN -->
  <section class="card hidden" id="viewAdmin">
    <div class="backbar"><button class="btn-ghost" id="backAdmin">‚Üê Atr√°s</button><h2>Administraci√≥n</h2><span class="badge" id="freeOnAdmin">‚Äî / ‚Äî</span></div>

    <!-- Par√°metros -->
    <div class="row">
      <div><label>Primer intervalo (min)</label><input id="tFirstMin" type="number" min="0" /></div>
      <div><label>Precio primer intervalo ($)</label><input id="tFirstPrice" type="number" min="0" /></div>
      <div><label>Precio por minuto adicional ($)</label><input id="tPerMin" type="number" min="0" /></div>
      <div><label>M√°ximo diario por ticket ($)</label><input id="tDailyCap" type="number" min="0" /></div>
    </div>
    <div class="row">
      <div><label>Capacidad total de espacios</label><input id="tCapacity" type="number" min="0" /></div>
      <div style="align-self:flex-end"><button id="btnSaveTariff" class="btn-ok">Guardar par√°metros</button></div>
    </div>

    <hr/>

    <!-- Gesti√≥n de usuarios -->
    <div class="users-head">
      <h3>Usuarios</h3>
      <span class="muted">Admin puede crear/editar/eliminar usuarios</span>
    </div>

    <div class="users-form">
      <div><label>Usuario</label><input id="newUser" placeholder="nuevo usuario" autocomplete="off" /></div>
      <div><label>Contrase√±a</label><input id="newPass" placeholder="******" type="password" /></div>
      <div>
        <label>Rol</label>
        <select id="newRole">
          <option value="operador">Operador</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div style="align-self:flex-end"><button id="btnAddUser" class="btn-ok">Agregar usuario</button></div>
    </div>

    <table class="table" id="tblUsers">
      <thead><tr><th>Usuario</th><th>Rol</th><th>Acciones</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<!-- MODAL BUSCAR VEH√çCULO / TICKET PERDIDO -->
<div id="modalSearch" class="modal-backdrop">
  <div class="modal">
    <div class="backbar"><h3>Buscar Veh√≠culo</h3><button class="btn-ghost" id="closeSearch">‚úï Cerrar</button></div>
    <div class="row">
      <div><label>Patente</label><input id="searchPlate" class="upper" placeholder="AA-BB-11" /></div>
      <div>
        <label>Estado</label>
        <select id="searchStatus">
          <option value="todos">Todos</option>
          <option value="open">En estacionamiento</option>
          <option value="closed">Fuera del estacionamiento</option>
        </select>
      </div>
      <div style="align-self:flex-end"><button class="btn" id="btnSearchGo">Buscar</button></div>
    </div>
    <div class="table" style="margin-top:10px">
      <table>
        <thead><tr><th></th><th>ID</th><th>Patente</th><th>Ingreso</th><th>Estado</th></tr></thead>
        <tbody id="searchBody"></tbody>
      </table>
    </div>

    <hr/>
    <h3>Ticket perdido / Reimpresi√≥n</h3>
    <div class="row">
      <div><label>RUT due√±o</label><input id="lostOwnerRut" placeholder="12.345.678-9" /></div>
      <div><label>Nombre due√±o</label><input id="lostOwnerName" placeholder="Nombre del due√±o" /></div>
      <div><label>RUT usuario</label><input id="lostUserRut" placeholder="12.345.678-9" /></div>
      <div><label>Nombre usuario</label><input id="lostUserName" placeholder="Nombre del usuario" /></div>
      <div style="align-self:flex-end"><button class="btn-warn" id="btnReprintLost" disabled>Reimprimir ticket perdido</button></div>
    </div>
    <div class="muted" style="margin-top:8px">* Selecciona exactamente 1 ticket arriba para habilitar la reimpresi√≥n. Se registrar√° en reportes y fin de d√≠a.</div>
  </div>
</div>

<!-- MODAL EDITAR USUARIO -->
<div id="modalUser" class="modal-backdrop">
  <div class="modal">
    <div class="backbar"><h3>Editar usuario</h3><button class="btn-ghost" id="closeUserModal">‚úï Cerrar</button></div>
    <div class="row">
      <div><label>Usuario</label><input id="editUser" disabled /></div>
      <div>
        <label>Rol</label>
        <select id="editRole">
          <option value="operador">Operador</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div><label>Nueva contrase√±a (opcional)</label><input id="editPass" type="password" placeholder="dejar en blanco para no cambiar" /></div>
      <div style="align-self:flex-end"><button class="btn-ok" id="btnSaveUser">Guardar cambios</button></div>
    </div>
  </div>
</div>

<script>
/* ========= Config (Demo) ========= */
const TZ='America/Santiago';
const AUTO_CHARGE=false;
const DEFAULT_METHOD='efectivo';
const INACTIVITY_MIN=60;
const ALWAYS_LOGIN=true;

/* ========= Utils ========= */
const $ = (id)=>document.getElementById(id);
const fmtDate = (iso)=> new Date(iso).toLocaleString('es-CL',{timeZone:TZ,hour12:false});
const nowISO = ()=> new Date().toISOString();
const todayLocal = ()=> new Date().toLocaleDateString('en-CA',{timeZone:TZ}); // YYYY-MM-DD
function yesterLocal(){ const d=new Date(); const opt={timeZone:TZ}; const d2=new Date(d.toLocaleString('en-US',opt)); d2.setDate(d2.getDate()-1); return d2.toLocaleDateString('en-CA',opt); }
const money = (n)=> (Number(n||0)).toLocaleString('es-CL');
function genId(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
const SECRET='CAMBIA-ESTO-EN-PRODUCCION';
function signId(id){ const sig=CryptoJS.HmacSHA256(id,SECRET).toString(CryptoJS.enc.Hex).slice(0,16); return `${id}.${sig}`;}
function verifySigned(signed){ const [id,sig]=(signed||'').split('.'); if(!id||!sig)return null; const exp=CryptoJS.HmacSHA256(id,SECRET).toString(CryptoJS.enc.Hex).slice(0,16); return sig===exp? id:null; }

/* ========= Storage ========= */
const store={ get(k,def){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): def; }catch(_){ return def; } }, set(k,v){ localStorage.setItem(k, JSON.stringify(v)); }, del(k){ localStorage.removeItem(k); } };
if(!store.get('tickets')) store.set('tickets',{});      
if(!store.get('payments')) store.set('payments',[]);    
if(!store.get('lostTickets')) store.set('lostTickets',[]);
if(!store.get('users')) store.set('users',[
  {user:'admin', pass:'12345', role:'admin'},
  {user:'operador', pass:'67890', role:'operador'}
]);
if(!store.get('tariff')) store.set('tariff', { firstMinutes:20, firstPrice:500, perMin:20, dailyCap:10000 });
if(store.get('capacity')==null) store.set('capacity', 50);
if(!store.get('zClosedDate')) store.set('zClosedDate', '');         // bloqueo d√≠a actual (manual)
if(!store.get('zAutoLog')) store.set('zAutoLog', {});               // { 'YYYY-MM-DD': true } d√≠as ya auto-Z

/* ========= Sesi√≥n ========= */
const session = { user:null, role:null }; let inactivityTimer=null;
function saveSession(){ store.set('session', {user:session.user, role:session.role, at:nowISO()}); }
function loadSession(){ const s=store.get('session',null); if(!s) return false; session.user=s.user; session.role=s.role; return !!session.user; }
function clearSession(){ store.del('session'); session.user=null; session.role=null; stopIdleTimer(); }
function startIdleTimer(){ stopIdleTimer(); inactivityTimer=setTimeout(()=>{ alert('Sesi√≥n cerrada por inactividad'); logout(); }, INACTIVITY_MIN*60*1000); }
function stopIdleTimer(){ if(inactivityTimer){ clearTimeout(inactivityTimer); inactivityTimer=null; } }
['click','keydown','mousemove','wheel','touchstart'].forEach(ev=> addEventListener(ev, startIdleTimer, {passive:true}));

function login(u,p){
  const users=store.get('users',[]);
  const user = users.find(x=>x.user===u && x.pass===p);
  if(!user) return false;
  session.user=user.user; session.role=user.role; saveSession(); startIdleTimer(); return true;
}
function logout(){ clearSession(); updateHeader(); show('viewLogin'); }

/* ========= Navegaci√≥n + Active Tab ========= */
const VIEWS=['viewLogin','viewEntrada','viewSalida','viewReportes','viewAdmin'];
const navStack=[];
const navButtons = { viewEntrada: 'goEntrada', viewSalida: 'goSalida', viewReportes: 'goReportes', viewAdmin: 'goAdmin' };
function setActiveTab(id){
  Object.values(navButtons).forEach(bid=> $(bid)?.classList.remove('active'));
  const btnId = navButtons[id]; if(btnId) $(btnId).classList.add('active');
}
function show(id){
  VIEWS.forEach(v=>$(v).classList.add('hidden')); $(id).classList.remove('hidden');
  setActiveTab(id);
  updateOccupancyUI();
  if(id==='viewSalida') $('scanInput').focus();
  if(id==='viewEntrada'||id==='viewSalida') refreshZBanners();
}
function pushView(id){ const current=VIEWS.find(v=> !$(v).classList.contains('hidden')); if(current) navStack.push(current); show(id); }
function back(){ const prev=navStack.pop(); if(prev) show(prev); }

function updateHeader(){
  const logged = !!session.user;
  $('btnLogout').classList.toggle('hidden', !logged);
  $('goAdmin').classList.toggle('hidden', !(logged && session.role==='admin'));
  $('who').textContent = logged ? `Sesi√≥n: ${session.user} (${session.role})` : '';
  updateOccupancyUI();
}

$('goEntrada').onclick=()=>{ if(!session.user) return show('viewLogin'); pushView('viewEntrada'); $('patenteIn').focus(); };
$('goSalida').onclick =()=>{ if(!session.user) return show('viewLogin'); pushView('viewSalida'); $('scanInput').focus(); };
$('goReportes').onclick=()=>{ if(!session.user) return show('viewLogin'); applyFilter(); pushView('viewReportes'); };
$('goAdmin').onclick=()=>{ if(!(session.user && session.role==='admin')) return show('viewLogin'); loadAdminUI(); pushView('viewAdmin'); };
$('btnLogout').onclick = logout;

$('backEntrada').onclick=back; $('backSalida').onclick=back; $('backReportes').onclick=back; $('backAdmin').onclick=back;
window.addEventListener('keydown',(e)=>{
  if(e.altKey && (e.key==='e'||e.key==='E')){ e.preventDefault(); if(!session.user) return show('viewLogin'); pushView('viewEntrada'); $('patenteIn').focus(); }
  if(e.altKey && (e.key==='s'||e.key==='S')){ e.preventDefault(); if(!session.user) return show('viewLogin'); pushView('viewSalida'); $('scanInput').focus(); }
});

/* ========= Dise√±o alternativo ========= */
const DESIGN_KEY='altDesign';
(function loadDesignPref(){
  const alt = !!store.get(DESIGN_KEY,false);
  document.body.classList.toggle('alt', alt);
  $('toggleDesign').checked = alt;
})();
$('toggleDesign').addEventListener('change', (e)=>{
  document.body.classList.toggle('alt', e.target.checked);
  store.set(DESIGN_KEY, e.target.checked);
});

/* ========= Ocupaci√≥n ========= */
function getCapacity(){ return Number(store.get('capacity',50))||0; }
function setCapacity(v){ store.set('capacity', Number(v)||0); }
function countOpenTickets(){ const map=store.get('tickets',{}); let open=0; Object.values(map).forEach(t=>{ if(t.status==='open') open++; }); return open; }
function updateOccupancyUI(){
  const cap=getCapacity(), open=countOpenTickets(), free=Math.max(0, cap-open);
  const tag=$('occupancyTag'); tag.textContent=`Disponibles: ${free} / Capacidad: ${cap}`;
  tag.classList.remove('kpi-low','kpi-ok'); tag.classList.add(free<=5 ? 'kpi-low':'kpi-ok');
  ['freeOnEntrada','freeOnSalida','freeOnAdmin'].forEach(id=>{ const el=$(id); if(el) el.textContent=`${free} / ${cap}`; });
}

/* ========= Tarifa + C√°lculo ========= */
function getTariff(){ return store.get('tariff',{ firstMinutes:20, firstPrice:500, perMin:20, dailyCap:10000 }); }
function setTariff(t){ store.set('tariff', t); }
function calcCharge(inISO, outISO){
  const t=getTariff(); const mins=Math.max(0, Math.ceil((new Date(outISO)-new Date(inISO))/60000));
  let total= mins<=t.firstMinutes ? t.firstPrice : t.firstPrice + (mins - t.firstMinutes)*t.perMin;
  total=Math.min(total, t.dailyCap||Infinity);
  return {mins,total,cap:t.dailyCap||Infinity};
}

/* ========= Cierre Z (bloqueo manual del d√≠a actual) ========= */
function getZClosedDate(){ return store.get('zClosedDate','')||''; }
function setZClosedDate(d){ store.set('zClosedDate', d||''); }
function zLockedToday(){ return getZClosedDate()===todayLocal(); }
function refreshZBanners(){
  const locked = zLockedToday();
  $('zBannerEntrada').classList.toggle('hidden', !locked);
  $('zBannerSalida').classList.toggle('hidden', !locked);
}

/* ========= Admin UI ========= */
function loadAdminUI(){
  const t=getTariff(); $('tFirstMin').value=t.firstMinutes; $('tFirstPrice').value=t.firstPrice;
  $('tPerMin').value=t.perMin; $('tDailyCap').value=t.dailyCap; $('tCapacity').value=getCapacity();
  renderUsersTable();
}
$('btnSaveTariff').onclick=()=>{
  if(!(session.user && session.role==='admin')) return alert('Solo admin');
  const t={
    firstMinutes: Math.max(0, parseInt($('tFirstMin').value||'0',10)),
    firstPrice:   Math.max(0, parseInt($('tFirstPrice').value||'0',10)),
    perMin:       Math.max(0, parseInt($('tPerMin').value||'0',10)),
    dailyCap:     Math.max(0, parseInt($('tDailyCap').value||'0',10))
  };
  const cap=Math.max(0, parseInt($('tCapacity').value||'0',10));
  setTariff(t); setCapacity(cap); updateOccupancyUI(); alert('Par√°metros guardados.');
};

/* ===== Usuarios (CRUD) ===== */
function getUsers(){ return store.get('users',[]); }
function setUsers(list){ store.set('users', list); }
function countAdmins(list){ return list.filter(u=>u.role==='admin').length; }

function renderUsersTable(){
  const tbody=$('tblUsers').querySelector('tbody'); tbody.innerHTML='';
  const users=getUsers().slice().sort((a,b)=> a.user.localeCompare(b.user));
  users.forEach(u=>{
    const tr=document.createElement('tr');
    const pill=`<span class="role-pill">${u.role}</span>`;
    const actions=`
      <div class="actions">
        <button class="btn" data-edit="${u.user}">Editar</button>
        <button class="btn-cancel" data-del="${u.user}">Eliminar</button>
      </div>`;
    tr.innerHTML=`<td class="mono">${u.user}</td><td>${pill}</td><td>${actions}</td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-edit]').forEach(b=> b.onclick=()=> openEditUser(b.dataset.edit));
  tbody.querySelectorAll('button[data-del]').forEach(b=> b.onclick=()=> deleteUser(b.dataset.del));
}

$('btnAddUser').onclick=()=>{
  if(!(session.user && session.role==='admin')) return alert('Solo admin');
  const user=($('newUser').value||'').trim();
  const pass=($('newPass').value||'').trim();
  const role=$('newRole').value;
  if(!user || !pass) return alert('Usuario y contrase√±a son obligatorios.');
  const list=getUsers();
  if(list.find(u=>u.user===user)) return alert('Ese usuario ya existe.');
  list.push({user, pass, role});
  setUsers(list);
  $('newUser').value=''; $('newPass').value=''; $('newRole').value='operador';
  renderUsersTable();
  alert('Usuario creado.');
};

function deleteUser(user){
  if(!(session.user && session.role==='admin')) return alert('Solo admin');
  if(user===session.user) return alert('No puedes eliminar la sesi√≥n actual.');
  const list=getUsers();
  const u=list.find(x=>x.user===user);
  if(!u) return;
  if(u.role==='admin' && countAdmins(list)<=1) return alert('Debe existir al menos un admin.');
  if(!confirm(`¬øEliminar usuario "${user}"?`)) return;
  const next=list.filter(x=>x.user!==user);
  setUsers(next);
  renderUsersTable();
  alert('Usuario eliminado.');
}

/* Modal editar */
const modalUser=$('modalUser');
function openEditUser(username){
  const list=getUsers();
  const u=list.find(x=>x.user===username); if(!u) return;
  $('editUser').value=u.user;
  $('editRole').value=u.role;
  $('editPass').value='';
  modalUser.style.display='flex';
}
$('closeUserModal').onclick=()=> modalUser.style.display='none';
$('btnSaveUser').onclick=()=>{
  const username=$('editUser').value;
  const newRole=$('editRole').value;
  const newPass=$('editPass').value;
  const list=getUsers();
  const idx=list.findIndex(x=>x.user===username);
  if(idx<0) return;
  if(list[idx].role==='admin' && newRole!=='admin' && countAdmins(list)<=1){
    return alert('Debe existir al menos un admin.');
  }
  list[idx].role=newRole;
  if(newPass) list[idx].pass=newPass;
  setUsers(list);
  modalUser.style.display='none';
  renderUsersTable();
  alert('Cambios guardados.');
};

/* ========= Entrada: generar ticket + PDF (45x250 con QR JPEG 35mm) ========= */
$('patenteIn').addEventListener('input',(e)=>{ const pos=e.target.selectionStart; e.target.value=e.target.value.toUpperCase(); e.target.setSelectionRange(pos,pos); });
function renderQRPreview(text){ const el=$('qrPreview'); el.innerHTML=''; new QRCode(el,{text, width:180, height:180, correctLevel:QRCode.CorrectLevel.M}); }
function buildQRDataURL(text){
  const tmp=document.createElement('div'); new QRCode(tmp,{text,width:180,height:180,correctLevel:QRCode.CorrectLevel.M});
  const src=tmp.querySelector('canvas')||tmp.querySelector('img');
  const canvas=document.createElement('canvas'); canvas.width=180; canvas.height=180; const ctx=canvas.getContext('2d');
  if(src){ try{ ctx.drawImage(src,0,0);}catch(_){}} else { ctx.fillStyle='#fff'; ctx.fillRect(0,0,180,180); }
  return canvas.toDataURL('image/jpeg',0.95);
}
function saveTicket(t){ const map=store.get('tickets',{}); map[t.id]=t; store.set('tickets',map); }
function getTicket(id){ const map=store.get('tickets',{}); return map[id]||null; }
function setTicket(id,t){ const map=store.get('tickets',{}); map[id]=t; store.set('tickets',map); }
function savePayment(ticketId,total,method){ const pays=store.get('payments',[]); pays.push({ticketId,total,method,at:nowISO(),by:session.user}); store.set('payments',pays); }
/* Duplicado patente (ticket abierto) */
function plateHasOpen(plate){
  plate = (plate||'').toUpperCase().trim();
  const map=store.get('tickets',{}); return Object.values(map).some(t=> t.plate.toUpperCase()===plate && t.status==='open');
}
function printTicketPDF({plate,inISO,signed,qrDataURL,welcome}){
  const { jsPDF } = window.jspdf;
  const W = 45, H = 250, M = 3;
  const doc = new jsPDF({ unit:'mm', format:[W,H], orientation:'portrait' });

  let y = 8, cx = W/2, inner = W - M*2, lh = 5;

  // T√≠tulo
  doc.setFont('helvetica','bold'); doc.setFontSize(11);
  doc.splitTextToSize('Parking Espacio Quintalba - Rengo', inner).forEach(line => { doc.text(line, cx, y, {align:'center'}); y += lh; });

  // Saludo
  doc.setFont('helvetica','normal'); doc.setFontSize(9);
  doc.splitTextToSize((welcome || '¬°Bienvenido!'), inner).forEach(line => { doc.text(line, cx, y, {align:'center'}); y += lh; });
  y += 2;

  // Patente
  doc.setFont('helvetica','bold'); doc.setFontSize(15);
  doc.text(plate, cx, y, {align:'center'}); y += 8;

  // Hora de ingreso (wrap seguro)
  doc.setFont('helvetica','normal'); doc.setFontSize(9);
  doc.text('Ingreso:', M, y);
  const inStr = new Date(inISO).toLocaleString('es-CL', { timeZone:TZ, hour12:false });
  const inLines = doc.splitTextToSize(inStr, inner * 0.75);
  inLines.forEach((line, i) => { doc.text(line, W - M, y + i*lh, {align:'right'}); });
  y += Math.max(lh, inLines.length * lh) + 3;

  // Separador
  doc.setDrawColor(120); doc.line(M, y, W - M, y); y += 4;

  // Mensaje recordatorio
  doc.setFontSize(8);
  doc.splitTextToSize('Recuerde presentar su ticket para el cobro', inner).forEach(line => { doc.text(line, cx, y, {align:'center'}); y += lh-1; });
  y += 1;

  // ID
  doc.setFontSize(8);
  doc.splitTextToSize(`ID: ${signed}`, inner).forEach(line => { doc.text(line, M, y); y += lh-1; });
  y += 2;

  // QR
  if (qrDataURL) {
    const QRW = 35, QRH = 35, x = (W - QRW) / 2;
    doc.addImage(qrDataURL, 'JPEG', x, y, QRW, QRH);
    y += QRH + 6;
  }

  // Pie
  doc.setFontSize(7);
  doc.text('Desarrollado por ARSM Servicios', cx, y, {align:'center'}); y += 4;

  const blob = doc.output('blob');
  const url = URL.createObjectURL(blob);
  const w = window.open(url);
  if (w) { w.onload = () => { try { w.focus(); w.print(); } catch(_) {} }; }
  else { doc.save(`ticket_${plate}.pdf`); }
}

$('btnGenerar').onclick=()=>{
  if(!session.user) return show('viewLogin');
  if(zLockedToday()){ alert('Cierre Z activo: no se permiten nuevas entradas hoy.'); return; }
  const plate=$('patenteIn').value.trim().toUpperCase(); const welcome=$('saludoIn').value.trim()||'¬°Bienvenido!';
  if(!plate){ alert('Ingresa la patente'); $('patenteIn').focus(); return; }

  if (plateHasOpen(plate)) {
    const map=store.get('tickets',{}); 
    const openOnPlate=Object.values(map).filter(t=>t.plate.toUpperCase()===plate && t.status==='open').sort((a,b)=> a.in < b.in ? 1 : -1);
    const lastIn = openOnPlate.length ? fmtDate(openOnPlate[0].in) : 'fecha desconocida';
    const ok = confirm(`‚ö†Ô∏è La patente ${plate} ya tiene ticket abierto (ingreso: ${lastIn}).\n¬øCrear otro ticket igualmente?`);
    if(!ok) return;
  }

  const id=genId(), signed=signId(id), inISO=nowISO();
  const t={id,signed,plate,in:inISO,out:null,status:'open',by:session.user}; saveTicket(t);
  renderQRPreview(signed); $('idPreview').textContent=signed;
  const qrDataURL=buildQRDataURL(signed); printTicketPDF({plate,inISO,signed,qrDataURL,welcome});
  $('patenteIn').value=''; $('patenteIn').focus(); updateOccupancyUI();
};

/* ========= Salida / Cobro ========= */
function handleSigned(raw){
  if(!session.user) return show('viewLogin');
  if(zLockedToday()){ setMsg('Cierre Z activo: no se pueden realizar cobros.',true); return; }
  const id=verifySigned(raw); if(!id){ setMsg('QR/ID inv√°lido',true); return; }
  const t=getTicket(id); if(!t){ setMsg('Ticket no encontrado',true); return; }
  if(t.status==='closed'){ setMsg('El veh√≠culo ya est√° fuera del estacionamiento.',true); return; }
  const outISO=nowISO(); const {mins,total,cap}=calcCharge(t.in,outISO);
  $('chPlate').textContent=t.plate; $('chIn').textContent=fmtDate(t.in); $('chOut').textContent=fmtDate(outISO);
  $('chDur').textContent=String(mins); $('chCap').textContent=money(cap); $('bigAmount').textContent='$'+money(total);
  $('chargeArea').classList.remove('hidden'); $('chargeArea').dataset.id=id; $('chargeArea').dataset.total=total;
  setMsg('Listo para cobrar');
}
function setMsg(text,isErr=false){ const el=$('salidaMsg'); el.textContent=text; el.style.background=isErr?'#3a1111':'#0d1c32'; }
$('scanInput').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); const raw=$('scanInput').value.trim(); if(!raw) return; handleSigned(raw); $('scanInput').select(); } });

function doCharge(method){
  if(zLockedToday()){ alert('Cierre Z activo: no se pueden realizar cobros.'); return; }
  const id=$('chargeArea').dataset.id; const total=Number($('chargeArea').dataset.total||0); const t=getTicket(id);
  if(!t) return alert('Ticket no encontrado');
  if(!confirm(`Confirma cobro de $${money(total)} por ${method}?`)) return;
  t.out=nowISO(); t.status='closed'; t.payMethod=method; setTicket(id,t); savePayment(id,total,method);
  $('chargeArea').classList.add('hidden'); setMsg(`Cobrado $${money(total)} (${method})`);
  applyFilter(); updateOccupancyUI();
  navStack.length = 0; show('viewEntrada'); $('patenteIn').focus();
}
$('btnCobrarEfe').onclick=()=> doCharge('efectivo');
$('btnCobrarTx').onclick =()=> doCharge('transbank');

/* ========= Reportes + Filtros ========= */
function defaultDates(){ const d=todayLocal(); $('filterFrom').value=d; $('filterTo').value=d; }
function ticketDateLocalDay(iso){ return new Date(iso).toLocaleDateString('en-CA',{timeZone:TZ}); }
function inRange(t){ const f=$('filterFrom').value||'0000-01-01', to=$('filterTo').value||'9999-12-31'; const day=ticketDateLocalDay(t.in); return (day>=f && day<=to); }
function getFilteredTickets(){
  const map=store.get('tickets',{}), all=Object.values(map);
  const status=$('filterStatus').value, plateQ=($('filterPlate').value||'').trim().toUpperCase();
  return all.filter(t=>{
    if(!inRange(t)) return false;
    if(status==='abiertos' && t.status!=='open') return false;
    if(status==='cerrados' && t.status!=='closed') return false;
    if(plateQ && !t.plate.toUpperCase().includes(plateQ)) return false;
    return true;
  }).sort((a,b)=>(a.in<b.in?1:-1));
}
function calcSummaryOnFiltered(){
  const pays=store.get('payments',[]); const pm=new Map(pays.map(p=>[p.ticketId,p]));
  const list=getFilteredTickets().filter(t=>t.status==='closed');
  const total=list.reduce((acc,t)=> acc + (pm.get(t.id)?.total||0), 0);
  return { total, count:list.length };
}
function fillTable(){
  const tbody=$('tblTickets').querySelector('tbody'); tbody.innerHTML='';
  const pays=store.get('payments',[]); const pm=new Map(pays.map(p=>[p.ticketId,p]));
  const list = getFilteredTickets();
  list.forEach(t=>{
    const p=pm.get(t.id); const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="mono">${t.id}</td>
      <td class="mono">${t.plate}</td>
      <td class="mono">${fmtDate(t.in)}</td>
      <td class="mono">${t.out?fmtDate(t.out):'-'}</td>
      <td>${t.status==='open'?'En estacionamiento':'Fuera del estacionamiento'}</td>
      <td class="mono">${t.out? money(p?.total||0): '-'}</td>
      <td>${t.out? (p?.method||'-') : '-'}</td>
      <td>${t.by||''}</td>`;
    tbody.appendChild(tr);
  });
  const s=calcSummaryOnFiltered();
  $('sumTotal').textContent = '$'+money(s.total);
  $('sumCount').textContent = String(s.count);
}
function applyFilter(){ fillTable(); }
$('btnApplyFilter').onclick=applyFilter;
$('filterPlate').addEventListener('input',()=>{ const el=$('filterPlate'); const pos=el.selectionStart; el.value=el.value.toUpperCase(); el.setSelectionRange(pos,pos); });

/* ===== Utilidades de Cierre X / Z ===== */
function ticketDateLocalDay(iso){ return new Date(iso).toLocaleDateString('en-CA',{timeZone:TZ}); } // redefine por seguridad
function buildDailyData(day){
  const map=store.get('tickets',{}), pays=store.get('payments',[]);
  const pm=new Map(pays.map(p=>[p.ticketId,p]));
  const rows=Object.values(map).filter(t=> ticketDateLocalDay(t.in)===day && t.status==='closed');
  const total=rows.reduce((acc,t)=> acc + (pm.get(t.id)?.total||0), 0);
  const lost=store.get('lostTickets',[]).filter(x=> ticketDateLocalDay(x.at)===day);
  return { rows, total, count:rows.length, lost, pm };
}
function buildDailyPDF(day, prefix){
  const {jsPDF}=window.jspdf; const doc=new jsPDF({orientation:'landscape'});
  doc.setFontSize(14); doc.text(`${prefix==='cierre_z'?'Cierre Z':'Cierre X'} ‚Äì ${day}`,14,18);
  doc.setFontSize(10); doc.text(`Generado: ${new Date().toLocaleString('es-CL',{timeZone:TZ,hour12:false})}`,14,25);
  let y=34; doc.setFontSize(9);

  const {rows,total,count,lost,pm}=buildDailyData(day);

  doc.text('Patente',14,y); doc.text('Ingreso',40,y); doc.text('Salida',90,y); doc.text('Monto',140,y); doc.text('Medio',165,y); y+=4; doc.line(14,y,200,y); y+=6;
  rows.forEach(r=>{ const p=pm.get(r.id); const val=p?.total||0;
    doc.text(r.plate,14,y); doc.text(fmtDate(r.in),40,y); doc.text(fmtDate(r.out),90,y);
    doc.text(money(val),140,y,{align:'right'}); doc.text(p?.method||'',165,y); y+=6; if(y>180){ doc.addPage('landscape'); y=20; }
  });
  y+=6; doc.line(14,y,200,y); y+=8; doc.setFontSize(12);
  doc.text(`Total ventas: $ ${money(total)}`,14,y); doc.text(`Veh√≠culos fuera: ${count}`,100,y);

  // Perdidos
  y+=12; doc.setFontSize(11); doc.text('Tickets perdidos reimpresos',14,y); y+=6; doc.setFontSize(9);
  doc.text('Patente',14,y); doc.text('Due√±o',45,y); doc.text('Usuario',110,y); doc.text('Fecha',165,y); y+=4; doc.line(14,y,200,y); y+=6;
  lost.forEach(x=>{
    doc.text(x.plate||'',14,y);
    doc.text(`${x.ownerRut||''} ‚Äì ${x.ownerName||''}`,45,y);
    doc.text(`${x.userRut||''} ‚Äì ${x.userName||''}`,110,y);
    doc.text(fmtDate(x.at),165,y);
    y+=6; if(y>180){ doc.addPage('landscape'); y=20; }
  });

  doc.save(`${prefix}_${day}.pdf`);
}
function buildDailyXLSX(day, prefix){
  const wb=XLSX.utils.book_new();
  const {rows,total,count,lost,pm}=buildDailyData(day);

  const sheetRows=[['ID','Patente','Ingreso','Salida','Monto','Medio','Operador','Estado']];
  rows.forEach(t=>{
    const p=pm.get(t.id);
    sheetRows.push([t.id,t.plate,fmtDate(t.in),fmtDate(t.out),p?.total||0,p?.method||'',t.by||'','Fuera del estacionamiento']);
  });
  const ws=XLSX.utils.aoa_to_sheet(sheetRows); XLSX.utils.book_append_sheet(wb, ws, 'Cierre');

  const lostRows=[['TicketID','Patente','Fecha reimpresi√≥n','RUT due√±o','Nombre due√±o','RUT usuario','Nombre usuario','Operador']];
  lost.forEach(x=> lostRows.push([x.ticketId,x.plate,fmtDate(x.at),x.ownerRut,x.ownerName,x.userRut,x.userName,x.by]));
  const ws2=XLSX.utils.aoa_to_sheet(lostRows); XLSX.utils.book_append_sheet(wb, ws2, 'TicketsPerdidos');

  const ws3=XLSX.utils.aoa_to_sheet([['Resumen'],['Total ventas del d√≠a', total],['Veh√≠culos fuera', count]]);
  XLSX.utils.book_append_sheet(wb, ws3, 'Resumen');

  XLSX.writeFile(wb, `${prefix}_${day}.xlsx`);
}

/* Bot√≥n Cierre X (no bloquea) */
$('btnCierreX').onclick=()=>{
  const day=todayLocal();
  if(!confirm(`Cierre X (${day}): genera XLSX + PDF sin bloquear operaciones.\n¬øContinuar?`)) return;
  buildDailyXLSX(day,'cierre_x');
  buildDailyPDF(day,'cierre_x');
  alert('Cierre X generado (XLSX + PDF).');
};

/* Bot√≥n Cierre Z (bloquea d√≠a actual) */
$('btnCierreZ').onclick=()=>{
  const day=todayLocal();
  if(!confirm(`‚ö†Ô∏è Cierre Z (${day}): genera XLSX + PDF y BLOQUEA nuevas operaciones por el resto del d√≠a.\nNo podr√°s ingresar ni cobrar hasta el d√≠a siguiente.\n\n¬øConfirmas Cierre Z?`)) return;
  buildDailyXLSX(day,'cierre_z');
  buildDailyPDF(day,'cierre_z');
  setZClosedDate(day);
  refreshZBanners();
  alert('Cierre Z aplicado. Operaciones bloqueadas hasta el pr√≥ximo d√≠a.');
};

/* ========= Modal Buscar Veh√≠culo / Ticket perdido ========= */
const modal=$('modalSearch');
function openSearch(){ modal.style.display='flex'; renderSearch(); }
function closeSearch(){ modal.style.display='none'; resetLostForm(); updateLostSelectionState(); }
$('btnBuscar').onclick=()=>{ if(!session.user) return show('viewLogin'); openSearch(); };
$('closeSearch').onclick=closeSearch; $('btnSearchGo').onclick=renderSearch;
$('searchPlate').addEventListener('input',()=>{ const el=$('searchPlate'); const pos=el.selectionStart; el.value=el.value.toUpperCase(); el.setSelectionRange(pos,pos); });

function renderSearch(){
  const tbody=$('searchBody'); tbody.innerHTML='';
  const plateQ=($('searchPlate').value||'').trim().toUpperCase(); const st=$('searchStatus').value;
  const map=store.get('tickets',{}); const rows=Object.values(map).filter(t=>{
    if(st!=='todos' && t.status!==st) return false;
    if(plateQ && !t.plate.toUpperCase().includes(plateQ)) return false;
    return true;
  }).sort((a,b)=>(a.in<b.in?1:-1));

  rows.forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="checkbox" class="selTicket" data-id="${t.id}" /></td>
      <td class="mono">${t.id}</td>
      <td class="mono">${t.plate}</td>
      <td class="mono">${fmtDate(t.in)}</td>
      <td>${t.status==='open'?'En estacionamiento':'Fuera del estacionamiento'}</td>`;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('.selTicket').forEach(cb=>{
    cb.addEventListener('change', updateLostSelectionState);
  });
  updateLostSelectionState();
}

function resetLostForm(){ $('lostOwnerRut').value=''; $('lostOwnerName').value=''; $('lostUserRut').value=''; $('lostUserName').value=''; }
function validRutLike(s){ return !!(s && s.length>=8); }
function getSelectedTicketIds(){ return Array.from(document.querySelectorAll('#searchBody .selTicket:checked')).map(cb=> cb.dataset.id); }
function updateLostSelectionState(){ const ids=getSelectedTicketIds(); $('btnReprintLost').disabled=(ids.length!==1); }

$('btnReprintLost').onclick=()=>{
  const ids=getSelectedTicketIds(); if(ids.length!==1){ alert('Selecciona exactamente 1 ticket.'); return; }
  const t=getTicket(ids[0]); if(!t) return alert('Ticket no encontrado');

  const ownerRut=$('lostOwnerRut').value.trim(), ownerName=$('lostOwnerName').value.trim();
  const userRut=$('lostUserRut').value.trim(), userName=$('lostUserName').value.trim();
  if(!validRutLike(ownerRut)||!ownerName||!validRutLike(userRut)||!userName){ return alert('Completa RUTs y nombres.'); }

  const lost=store.get('lostTickets',[]);
  lost.push({ ticketId:t.id, plate:t.plate, ownerRut, ownerName, userRut, userName, at:nowISO(), by:session.user });
  store.set('lostTickets',lost);

  const qrDataURL=buildQRDataURL(t.signed);
  printTicketPDF({ plate:t.plate, inISO:t.in, signed:t.signed, qrDataURL, welcome:'Reimpresi√≥n por ticket perdido' });
  alert('Reimpresi√≥n registrada.');
  resetLostForm();
};

/* ========= Login Flow ========= */
function doLoginFlow(){
  const u=$('loginUser').value.trim(), p=$('loginPass').value.trim();
  if(!login(u,p)){ alert('Credenciales inv√°lidas'); return; }
  updateHeader(); navStack.length=0; show('viewEntrada'); $('patenteIn').focus();
}
$('doLogin').onclick=doLoginFlow;
['loginUser','loginPass'].forEach(id=> $(id).addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); doLoginFlow(); } }));

/* ========= Auto Cierre Z a las 00:00 si falt√≥ (para AYER) ========= */
function autoZIfNeeded(){
  // ejecuta cada minuto; si cambia el d√≠a local y AYER no tuvo Z manual ni auto, genera auto Z (ayer)
  const nowDay = todayLocal();
  const yDay = yesterLocal();
  const log = store.get('zAutoLog', {});
  // si ya se registr√≥ auto Z de ayer, no repetir
  if (log[yDay]) return;

  // condici√≥n de medianoche: cuando el d√≠a actual es distinto al √∫ltimo check
  // simplificado: si la hora local est√° dentro del primer minuto del d√≠a, intentamos auto-Z
  const now = new Date().toLocaleTimeString('en-GB',{timeZone:TZ,hour12:false});
  // "00:00" a "00:01"
  if (now.startsWith('00:00') || now.startsWith('00:01')) {
    // si ayer NO tuvo cierre Z manual (zClosedDate != ayer), generamos ambos archivos para AYER
    if (store.get('zClosedDate','') !== yDay) {
      try{
        buildDailyXLSX(yDay,'cierre_z_auto');
        buildDailyPDF(yDay,'cierre_z_auto');
      }catch(e){ console.error('Auto Z fail',e); }
    }
    // marcar auto-Z de ayer (sea que hubiera o no manual, para no repetirse)
    log[yDay] = true; store.set('zAutoLog', log);
  }
}
// chequeo cada 30s para mayor robustez
setInterval(autoZIfNeeded, 30000);

/* ========= Init ========= */
(function init(){
  // Login siempre
  clearSession(); updateHeader(); show('viewLogin'); defaultDates(); refreshZBanners();

  // Dise√±o alt preferencia cargada arriba
})();
function defaultDates(){ const d=todayLocal(); const fFrom=document.getElementById('filterFrom'); const fTo=document.getElementById('filterTo'); if(fFrom) fFrom.value=d; if(fTo) fTo.value=d; }
</script>
</body>
</html>
